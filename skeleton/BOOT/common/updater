#!/bin/sh

# NOTE: becomes .tmp_update/updater

# LessOS provides device name - map to LessUI platform
if [ -n "$LESSOS_DEVICE" ]; then
	case "$LESSOS_DEVICE" in
		*"RGB30"*)
			PLATFORM="rgb30"
			;;
		*"Retroid"*|*"Pocket"*)
			PLATFORM="retroid"
			;;
		*"RG353P"*|*"RG353V"*|*"RG353M"*|*"RG353"*)
			# Future: map to rg353 platform if/when we add it
			# For now, unsupported
			echo "LessUI: Device $LESSOS_DEVICE not yet supported"
			PLATFORM=""
			;;
		*)
			echo "LessUI: Unknown LessOS device: $LESSOS_DEVICE"
			PLATFORM=""
			;;
	esac
else
	# Stock OS - detect platform from cpuinfo
	INFO=$(cat /proc/cpuinfo 2>/dev/null)
	case $INFO in
	*"sun8i"*)
		if [ -d /usr/miyoo ]; then
			PLATFORM="my282" # Miyoo A30
		else
			PLATFORM="trimuismart"
		fi
		;;
	*"SStar"*)
		PLATFORM="miyoomini"
		;;
	*"TG5050"*)
		PLATFORM="tg5050" # Trimui Smart Pro S
		;;
	*"TG5040"*|*"TG3040"*)
		PLATFORM="tg5040" # Trimui Smart Pro or Brick
		;;
	*"0xd03"*)
		PLATFORM="zero28" # MagicX Mini Zero 28
		;;
	*"0xd05"*)
		PLATFORM="my355" # Miyoo Flip
		;;
	esac

	# fallback for tg5040 20240413 recovery firmware
	if [ -z "$PLATFORM" ] && [ -f /usr/trimui/bin/runtrimui.sh ]; then
		PLATFORM="tg5040"
	fi
fi

# Use LessOS storage path if set, otherwise default to stock path
SDCARD_PATH="${LESSOS_STORAGE:-/mnt/SDCARD}"

exec "$SDCARD_PATH/.tmp_update/$PLATFORM.sh" # &> $SDCARD_PATH/boot.txt

# Rendering Pipeline Refactoring

## Overview

This document tracks the progress of refactoring the rendering pipeline to eliminate duplication across platforms.

**Goal:** Reduce ~1,170 lines of duplicated code across 10 platforms into shared modules.

**Started:** 2025-12-01
**Completed:** 2025-12-01

---

## Status: COMPLETE ✓

All 10 platforms have been migrated to use the shared rendering modules. The refactored `platform.c` files are now active and all platforms build successfully.

---

## Phase 1: Effect System Extraction

**Status:** COMPLETE

Extract shared effect state management into `effect_system.c/h`.

### Files Created
- [x] `workspace/all/common/effect_system.h`
- [x] `workspace/all/common/effect_system.c`

### Features Implemented
- [x] `EffectState` struct (replaces 10 duplicated structs)
- [x] `EFFECT_getOpacity(scale)` - linear formula: `40 + (scale * 20)`
- [x] `EFFECT_getPatternPath()` - generates scale-specific paths (line-2.png, etc.)
- [x] `EFFECT_getPatternScale(scale)` - clamps to available patterns (2-8)
- [x] `EFFECT_needsUpdate()` / `EFFECT_markLive()` (state management)
- [x] `EFFECT_init()`, `EFFECT_setType()`, `EFFECT_setScale()`, `EFFECT_setColor()`
- [x] `EFFECT_applyPending()` for deferred state updates

### Effect Patterns
All platforms use scale-specific patterns generated by `scripts/generate-effect-patterns.py`:
- `line-{2-8}.png` - Horizontal scanline shadows
- `grid-{2-8}.png` - 2×2 pixel grid scaled up
- `crt-{2-8}.png` - 6-column vertical stripe pattern

Opacity follows a simple linear formula for all effect types:
```
opacity = 40 + (scale * 20)
```
| Scale | Opacity |
|-------|---------|
| 2 | 80 |
| 3 | 100 |
| 4 | 120 |
| 5 | 140 |
| 6 | 160 |
| 7 | 180 |
| 8 | 200 |

---

## Phase 2: Render Common Extraction

**Status:** COMPLETE

Extract shared rendering math into `render_common.c/h`.

### Files Created
- [x] `workspace/all/common/render_common.h`
- [x] `workspace/all/common/render_common.c`

### Features Implemented
- [x] `RenderDestRect` struct
- [x] `RENDER_calcDestRect()` - aspect ratio, native, fullscreen modes
- [x] `RENDER_calcHardScale()` - simple logic: native=1x, else=4x
- [x] `RENDER_rgb565ToRgb888()` / `RENDER_rgb888ToRgb565()` - color conversion

---

## Phase 3: SDL2 Render Backend

**Status:** COMPLETE (all 7 platforms migrated)

Unified SDL2 rendering backend created.

### Files Created
- [x] `workspace/all/common/render_sdl2.h`
- [x] `workspace/all/common/render_sdl2.c`

### Features Implemented
- [x] `SDL2_RenderContext` struct
- [x] `SDL2_Config` for platform-specific settings (auto_rotate, has_hdmi, brightness_alpha)
- [x] `SDL2_initVideo()` / `SDL2_quitVideo()`
- [x] `SDL2_resizeVideo()` with hard_scale calculation
- [x] `SDL2_blitRenderer()` / `SDL2_flip()` with rotation support
- [x] `SDL2_setSharpness()` for crisp/soft/sharp modes
- [x] `SDL2_setEffect()` / `SDL2_setEffectColor()`
- [x] `SDL2_getScaler()` / `SDL2_vsync()`

### Platforms Migrated
- [x] tg5040 (reference implementation)
- [x] rg35xxplus
- [x] rgb30
- [x] my282
- [x] my355
- [x] zero28
- [x] magicmini

---

## Phase 4: SDL1 Platform Updates

**Status:** COMPLETE

Update SDL1 platforms to use effect_system for consistency.

### Platforms Updated
- [x] miyoomini (uses EffectState, EFFECT_getOpacity, EFFECT_getPatternPath)
- [x] trimuismart (uses EffectState, EFFECT_getOpacity, EFFECT_getPatternPath)
- [x] rg35xx (uses EffectState, EFFECT_getOpacity, EFFECT_getPatternPath)

### SDL1 Platform Results

| Platform | Before | After | Reduction |
|----------|--------|-------|-----------|
| miyoomini | 1,182 lines | 774 lines | **-408 (35%)** |
| trimuismart | 1,108 lines | 622 lines | **-486 (44%)** |
| rg35xx | 1,286 lines | 760 lines | **-526 (41%)** |
| **Total** | **3,576 lines** | **2,156 lines** | **-1,420 lines (40%)** |

---

## Code Reduction Tracking

### Actual Results (all 7 SDL2 platforms migrated)

| Platform | Before | After | Reduction |
|----------|--------|-------|-----------|
| tg5040 | 641 lines | 321 lines | **-320 (50%)** |
| rg35xxplus | 1,200 lines | 592 lines | **-608 (51%)** |
| rgb30 | 993 lines | 338 lines | **-655 (66%)** |
| my282 | 984 lines | 481 lines | **-503 (51%)** |
| my355 | 983 lines | 412 lines | **-571 (58%)** |
| zero28 | 840 lines | 316 lines | **-524 (62%)** |
| magicmini | 1,206 lines | 574 lines | **-632 (52%)** |
| **Total** | **6,847 lines** | **3,034 lines** | **-3,813 lines (56%)** |

### New Shared Code

| File | Lines | Purpose |
|------|-------|---------|
| effect_system.c | ~95 | Effect state, opacity formula, pattern paths |
| render_common.c | ~65 | Dest rect, hard_scale, color conversion |
| render_sdl2.c | ~340 | Unified SDL2 backend |
| **Total** | **~500** | Shared library |

### Net Savings (All Phases Complete)

**Phase 3 (SDL2 platforms):**
- Removed from platforms: 3,813 lines
- Added to shared: ~500 lines (render_sdl2, render_common, effect_system)

**Phase 4 (SDL1 platforms):**
- Removed from platforms: 1,420 lines
- Added to shared: 0 lines (reuses effect_system from Phase 1)

**Combined Total:**
- Total removed from platforms: 5,233 lines
- Total added to shared: ~500 lines
- **Net reduction: ~4,700 lines (45%)**

---

## Platform Backend Classification

| Platform | Backend | Shared Modules |
|----------|---------|----------------|
| miyoomini | MI_GFX | effect_system |
| trimuismart | DE2 (Sunxi) | effect_system |
| rg35xx | OWL DE | effect_system |
| tg5040 | SDL2 | render_sdl2, effect_system, render_common |
| rg35xxplus | SDL2 | render_sdl2, effect_system, render_common |
| rgb30 | SDL2 | render_sdl2, effect_system, render_common |
| my282 | SDL2 | render_sdl2, effect_system, render_common |
| my355 | SDL2 | render_sdl2, effect_system, render_common |
| zero28 | SDL2 | render_sdl2, effect_system, render_common |
| magicmini | SDL2 | render_sdl2, effect_system, render_common |

---

## New File Summary

```
workspace/all/common/
├── effect_system.h     ← NEW: Effect state management API
├── effect_system.c     ← NEW: Linear opacity formula, pattern paths
├── render_common.h     ← NEW: Dest rect, hard_scale, color conversion
├── render_common.c     ← NEW: Shared rendering math
├── render_sdl2.h       ← NEW: SDL2 backend API
├── render_sdl2.c       ← NEW: Unified SDL2 rendering
├── effect_utils.h      ← EXISTS: SDL2 texture effects
├── effect_utils.c      ← EXISTS: EFFECT_loadAndTile()
├── effect_surface.h    ← EXISTS: SDL1 surface effects
├── effect_surface.c    ← EXISTS: EFFECT_createTiledSurface()
└── scaler.c/h          ← EXISTS: NEON scalers

skeleton/SYSTEM/res/
├── line-{2-8}.png      ← Generated: Scanline patterns
├── grid-{2-8}.png      ← Generated: Grid patterns
└── crt-{2-8}.png       ← Generated: CRT patterns
```

---

## Adding a New SDL2 Platform

When adding a new SDL2 platform, use `render_sdl2`:

```c
// Add to platform.c
#include "render_sdl2.h"

static SDL2_RenderContext vid_ctx;

// Platform-specific config
static const SDL2_Config vid_config = {
    .auto_rotate = 0,       // 1 for portrait screens
    .has_hdmi = 0,          // 1 if HDMI output supported
    .brightness_alpha = 0,  // 1 if brightness via alpha blending
    .default_sharpness = SHARPNESS_SOFT,
};

SDL_Surface* PLAT_initVideo(void) {
    return SDL2_initVideo(&vid_ctx, FIXED_WIDTH, FIXED_HEIGHT, &vid_config);
}

void PLAT_quitVideo(void) { SDL2_quitVideo(&vid_ctx); }
void PLAT_clearVideo(SDL_Surface* s) { SDL2_clearVideo(&vid_ctx); }
void PLAT_clearAll(void) { SDL2_clearAll(&vid_ctx); }
SDL_Surface* PLAT_resizeVideo(int w, int h, int p) { return SDL2_resizeVideo(&vid_ctx, w, h, p); }
void PLAT_setSharpness(int s) { SDL2_setSharpness(&vid_ctx, s); }
void PLAT_setEffect(int e) { SDL2_setEffect(&vid_ctx, e); }
void PLAT_setEffectColor(int c) { SDL2_setEffectColor(&vid_ctx, c); }
scaler_t PLAT_getScaler(GFX_Renderer* r) { return SDL2_getScaler(&vid_ctx, r); }
void PLAT_blitRenderer(GFX_Renderer* r) { SDL2_blitRenderer(&vid_ctx, r); }
void PLAT_flip(SDL_Surface* s, int sync) { SDL2_flip(&vid_ctx, sync); }
void PLAT_vsync(int remaining) { SDL2_vsync(remaining); }
void PLAT_setVsync(int vsync) { /* handled by SDL_RENDERER_PRESENTVSYNC */ }
void PLAT_setVideoScaleClip(int x, int y, int w, int h) { /* not supported */ }
void PLAT_setNearestNeighbor(int enabled) { /* not supported */ }
```

---

## Testing Checklist

Build verification (all platforms pass):
- [x] miyoomini: `make PLATFORM=miyoomini build` ✓
- [x] trimuismart: `make PLATFORM=trimuismart build` ✓
- [x] rg35xx: `make PLATFORM=rg35xx build` ✓
- [x] tg5040: `make PLATFORM=tg5040 build` ✓
- [x] rg35xxplus: `make PLATFORM=rg35xxplus build` ✓
- [x] rgb30: `make PLATFORM=rgb30 build` ✓
- [x] my282: `make PLATFORM=my282 build` ✓
- [x] my355: `make PLATFORM=my355 build` ✓
- [x] zero28: `make PLATFORM=zero28 build` ✓
- [x] magicmini: `make PLATFORM=magicmini build` ✓
- [x] Full build: `make` ✓

Runtime testing (to be done on device):
- [ ] Launcher (minui) displays correctly
- [ ] Game rendering works (test with a simple ROM)
- [ ] Effects (scanlines, grid, CRT) work at various scales
- [ ] Sharpness settings work (soft, crisp)
- [ ] No visual regressions vs original code

---

## Design Principles

1. **Uniform behavior across platforms** - All platforms use identical effect opacity formula and pattern selection
2. **Simple formulas over lookup tables** - `opacity = 40 + (scale * 20)` replaces 8 separate tables
3. **Scale-specific patterns** - All effects use `{effect}-{scale}.png` patterns (scales 2-8)
4. **Minimal platform config** - SDL2_Config has only 4 fields (removed use_scaled_patterns)
5. **Hardware backends remain separate** - MI_GFX, DE2, OWL DE are too different to unify

---

## Notes

- Effect system uses a single linear opacity formula for all effect types
- All platforms use scale-specific patterns (no base patterns)
- render_common handles aspect ratio math consistently across all platforms
- SDL2 backend handles crisp scaling, rotation, effects in one place
- Platform files now focus on hardware-specific code (input, power, battery)
- MI_GFX and DE2 backends remain platform-specific (too different to unify)

#!/bin/sh
# Disable WiFi service

BIN_DIR="$(dirname "$0")"
PAK_DIR="$(dirname "$BIN_DIR")"

# shellcheck source=wifi-lib.sh
. "$BIN_DIR/wifi-lib.sh"
setup_wifi_paths "$PAK_DIR"

main() {
	normalize_platform

	echo "Preparing to disable wifi..."

	# Update system.json for platforms that use it
	SYSTEM_JSON_PATH="$(get_system_json_path)"
	if [ -n "$SYSTEM_JSON_PATH" ]; then
		set_system_wifi "$SYSTEM_JSON_PATH" 0
	fi

	# Stop wpa_supplicant
	if pgrep wpa_supplicant >/dev/null 2>&1; then
		echo "Stopping wpa_supplicant..."
		/etc/init.d/wpa_supplicant stop 2>/dev/null || true
		systemctl stop wpa_supplicant 2>/dev/null || true
		killall -9 wpa_supplicant 2>/dev/null || true
	fi

	# Stop DHCP client on miyoomini
	if [ "$PLATFORM" = "miyoomini" ]; then
		killall udhcpc 2>/dev/null || true
	fi

	# Mark interface down if it's not already down
	WIFI_DEV="$(get_wifi_interface)"
	if [ -d "/sys/class/net/$WIFI_DEV" ]; then
		operstate="$(cat "/sys/class/net/$WIFI_DEV/operstate" 2>/dev/null)"
		if [ "$operstate" != "down" ]; then
			echo "Marking $WIFI_DEV interface down..."
			if [ "$PLATFORM" = "rg35xxplus" ]; then
				ip link set "$WIFI_DEV" down 2>/dev/null || true
			else
				ifconfig "$WIFI_DEV" down 2>/dev/null || true
			fi
		fi
	fi

	# Block wireless if rfkill available
	if command -v rfkill >/dev/null 2>&1; then
		current_state="$(rfkill list wifi 2>/dev/null | grep 'blocked:' | head -1)"
		if ! echo "$current_state" | grep -q "blocked: yes"; then
			echo "Blocking wireless..."
			rfkill block wifi 2>/dev/null || true
		fi
	fi

	# Turn off WiFi power on miyoomini
	if [ -f /customer/app/axp_test ]; then
		/customer/app/axp_test wifioff
	fi

	# Reset wpa_supplicant config to template
	template_file="$PAK_DIR/res/wpa_supplicant.conf.tmpl"
	if [ -f "$PAK_DIR/res/wpa_supplicant.conf.$PLATFORM.tmpl" ]; then
		template_file="$PAK_DIR/res/wpa_supplicant.conf.$PLATFORM.tmpl"
	fi
	cp "$template_file" "$PAK_DIR/res/wpa_supplicant.conf"

	# Clean up rg35xxplus netplan
	if [ "$PLATFORM" = "rg35xxplus" ]; then
		rm -f /etc/netplan/01-netcfg.yaml
		netplan apply 2>/dev/null || true
		systemctl stop systemd-networkd 2>/dev/null || true
	fi

	# IWD-based platforms (LessOS) - disconnect and power off adapter
	if is_iwd_platform; then
		WIFI_DEV="$(get_wifi_interface)"

		# Disconnect and power off via iwctl
		# Note: wifictl disable only does rfkill block, doesn't power off device
		iwctl station "$WIFI_DEV" disconnect 2>/dev/null || true
		iwctl device "$WIFI_DEV" set-property Powered off 2>/dev/null || true

		# Block WiFi via rfkill
		if command -v rfkill >/dev/null 2>&1; then
			rfkill block wifi 2>/dev/null || true
		fi
	fi

	return 0
}

main "$@"

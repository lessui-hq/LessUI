#!/bin/sh
# Check if wifi is currently enabled
# Exit 0 = enabled, Exit 1 = disabled

BIN_DIR="$(dirname "$0")"
PAK_DIR="$(dirname "$BIN_DIR")"

# shellcheck source=wifi-lib.sh
. "$BIN_DIR/wifi-lib.sh"
setup_wifi_paths "$PAK_DIR"

main() {
	normalize_platform

	# IWD-based platforms (LessOS) - check if IWD is running and device is powered on
	if is_iwd_platform; then
		WIFI_DEV="$(get_wifi_interface)"

		# Check if IWD daemon is running
		pgrep -x iwd >/dev/null 2>&1 || return 1

		# Check rfkill status
		if command -v rfkill >/dev/null 2>&1; then
			wifi_status="$(rfkill list wifi 2>/dev/null || true)"
			echo "$wifi_status" | grep -q "blocked: yes" && return 1
		fi

		# Check if device is powered on via iwctl
		# iwctl device show outputs "Powered on/off"
		# Strip ANSI color codes from output
		powered="$(iwctl device "$WIFI_DEV" show 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g' | grep -i 'Powered' | awk '{print $NF}')"
		[ "$powered" = "on" ] && return 0
		return 1
	fi

	# Check system.json wifi flag (not used on rg35xxplus which uses systemd)
	SYSTEM_JSON_PATH="$(get_system_json_path)"
	if [ -n "$SYSTEM_JSON_PATH" ]; then
		wifi_enabled="$(get_system_wifi "$SYSTEM_JSON_PATH")"
		[ "$wifi_enabled" != "1" ] && return 1
	fi

	# Check rfkill status
	if command -v rfkill >/dev/null 2>&1; then
		wifi_status="$(rfkill list wifi 2>/dev/null || true)"
		echo "$wifi_status" | grep -q "blocked: yes" && return 1
	fi

	# Check wpa_supplicant process
	pgrep wpa_supplicant >/dev/null 2>&1 || return 1

	# WiFi is enabled if wpa_supplicant is running
	# (interface operstate being "up" only means connected, not enabled)
	return 0
}

main "$@"

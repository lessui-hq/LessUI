#!/bin/sh
# Enable WiFi service

BIN_DIR="$(dirname "$0")"
PAK_DIR="$(dirname "$BIN_DIR")"

export PATH="$PAK_DIR/bin/$PLATFORM:$PAK_DIR/bin:$PATH"
export LD_LIBRARY_PATH="$PAK_DIR/lib/$PLATFORM:$PAK_DIR/lib:$LD_LIBRARY_PATH"

main() {
	# Handle platform aliases (legacy: tg3040 was the original name for tg5040+brick)
	if [ "$PLATFORM" = "tg3040" ] && [ -z "$LESSUI_DEVICE" ]; then
		export LESSUI_DEVICE="brick"
		export LESSUI_PLATFORM="tg5040"
		export PLATFORM="tg5040"
	fi

	echo "Preparing to enable wifi..."

	# Update system.json for platforms that use it
	case "$PLATFORM" in
		miyoomini | my282 | my355 | tg5040)
			case "$PLATFORM" in
				miyoomini) SYSTEM_JSON_PATH="/appconfigs/system.json" ;;
				my282) SYSTEM_JSON_PATH="/config/system.json" ;;
				my355) SYSTEM_JSON_PATH="/userdata/system.json" ;;
				*) SYSTEM_JSON_PATH="/mnt/UDISK/system.json" ;;
			esac

			[ ! -f "$SYSTEM_JSON_PATH" ] && echo '{"wifi": 0}' >"$SYSTEM_JSON_PATH"
			[ ! -s "$SYSTEM_JSON_PATH" ] && echo '{"wifi": 0}' >"$SYSTEM_JSON_PATH"

			if [ -x /usr/trimui/bin/systemval ]; then
				/usr/trimui/bin/systemval wifi 1
			else
				jq '.wifi = 1' "$SYSTEM_JSON_PATH" >"/tmp/system.json.tmp"
				mv "/tmp/system.json.tmp" "$SYSTEM_JSON_PATH"
			fi
			;;
	esac

	# Unblock wireless if rfkill is available
	if command -v rfkill >/dev/null 2>&1; then
		echo "Unblocking wireless..."
		rfkill unblock wifi 2>/dev/null || true
	fi

	echo "Starting wpa_supplicant..."

	case "$PLATFORM" in
		miyoomini)
			killall wpa_supplicant 2>/dev/null || true
			killall udhcpc 2>/dev/null || true

			# Load WiFi kernel module if needed
			if ! grep -q 8188fu /proc/modules 2>/dev/null; then
				insmod "$PAK_DIR/res/miyoomini/8188fu.ko"
			fi

			/customer/app/wpa_cli -i wlan0 disconnect 2>/dev/null || true
			/customer/app/wpa_cli -i wlan0 terminate 2>/dev/null || true
			/customer/app/wpa_cli -i wlan0 reconfigure 2>/dev/null || true

			ifconfig lo up
			/customer/app/axp_test wifion
			sleep 2
			ifconfig wlan0 up
			/customer/app/wpa_supplicant -B -D nl80211 -iwlan0 -c /appconfigs/wpa_supplicant.conf

			# Wait for wpa_supplicant to start (max 3 seconds)
			timeout=0
			while [ $timeout -lt 30 ]; do
				pgrep wpa_supplicant >/dev/null 2>&1 && break
				sleep 0.1
				timeout=$((timeout + 1))
			done

			if ! pgrep wpa_supplicant >/dev/null 2>&1; then
				echo "Failed to start wpa_supplicant"
				return 1
			fi

			ln -sf /dev/null /tmp/udhcpc.log
			udhcpc -i wlan0 -s /etc/init.d/udhcpc.script &

			/customer/app/wpa_cli -i wlan0 reconnect
			iw dev wlan0 set power_save off
			;;

		tg5040)
			killall -15 wpa_supplicant 2>/dev/null || true
			killall -15 udhcpc 2>/dev/null || true
			ifconfig wlan0 up 2>/dev/null || true

			wpa_supplicant -B -D nl80211 -iwlan0 -c /etc/wifi/wpa_supplicant.conf -O /etc/wifi/sockets >/tmp/wpa_supplicant.log 2>&1

			# Handle stale socket file
			if grep -q "Delete '/etc/wifi/sockets/wlan0' manually" /tmp/wpa_supplicant.log 2>/dev/null; then
				killall -15 wpa_supplicant 2>/dev/null || true
				rm -f /etc/wifi/sockets/wlan0
				wpa_supplicant -B -D nl80211 -iwlan0 -c /etc/wifi/wpa_supplicant.conf -O /etc/wifi/sockets
			fi
			rm -f /tmp/wpa_supplicant.log

			# Wait for wpa_supplicant to start (max 3 seconds)
			timeout=0
			while [ $timeout -lt 30 ]; do
				pgrep wpa_supplicant >/dev/null 2>&1 && break
				sleep 0.1
				timeout=$((timeout + 1))
			done

			if ! pgrep wpa_supplicant >/dev/null 2>&1; then
				echo "Failed to start wpa_supplicant"
				return 1
			fi
			udhcpc -i wlan0 -n &
			;;

		my282)
			killall -9 wpa_supplicant 2>/dev/null || true
			killall -9 udhcpc 2>/dev/null || true
			ifconfig wlan0 up 2>/dev/null || true

			if ! /etc/init.d/wpa_supplicant start; then
				echo "Failed to start wpa_supplicant via init.d"
			fi

			# Wait for wpa_supplicant to start (max 3 seconds)
			timeout=0
			while [ $timeout -lt 30 ]; do
				pgrep wpa_supplicant >/dev/null 2>&1 && break
				sleep 0.1
				timeout=$((timeout + 1))
			done

			if ! pgrep wpa_supplicant >/dev/null 2>&1; then
				echo "Failed to start wpa_supplicant"
				return 1
			fi
			( (udhcpc -i wlan0 -q &) &)
			;;

		my355)
			killall -9 wpa_supplicant 2>/dev/null || true
			killall -9 udhcpc 2>/dev/null || true
			ifconfig wlan0 up 2>/dev/null || true

			wpa_supplicant -B -D nl80211 -iwlan0 -c /userdata/cfg/wpa_supplicant.conf

			# Wait for wpa_supplicant to start (max 3 seconds)
			timeout=0
			while [ $timeout -lt 30 ]; do
				pgrep wpa_supplicant >/dev/null 2>&1 && break
				sleep 0.1
				timeout=$((timeout + 1))
			done

			if ! pgrep wpa_supplicant >/dev/null 2>&1; then
				echo "Failed to start wpa_supplicant"
				return 1
			fi
			( (udhcpc -i wlan0 -q &) &)
			;;

		rg35xxplus)
			ip link set wlan0 up

			# Disable power save if iw is available
			if command -v iw >/dev/null 2>&1; then
				iw dev wlan0 set power_save off 2>/dev/null || true
			fi

			# Stop services for clean state
			systemctl stop systemd-networkd 2>/dev/null || true
			systemctl stop wpa_supplicant 2>/dev/null || true
			sleep 1

			# Start wpa_supplicant and wait for it to be active
			systemctl start wpa_supplicant

			# Wait for wpa_supplicant to reach active state (max 5 seconds, longer than other platforms due to systemd overhead)
			timeout=0
			while [ $timeout -lt 50 ]; do
				if systemctl is-active --quiet wpa_supplicant; then
					break
				fi
				sleep 0.1
				timeout=$((timeout + 1))
			done

			if ! systemctl is-active --quiet wpa_supplicant; then
				echo "Failed to start wpa_supplicant"
				systemctl status wpa_supplicant --no-pager 2>&1 || true
				return 1
			fi

			# Only start systemd-networkd after wpa_supplicant is ready
			systemctl start systemd-networkd

			# Apply netplan with timeout to avoid hanging on slow/unavailable networks
			if ! timeout 15 netplan apply 2>/dev/null; then
				echo "Warning: netplan apply timed out or failed (continuing anyway)"
				# Don't return 1 - WiFi might still work, just slower to connect
			fi
			;;

		*)
			echo "$PLATFORM is not a supported platform for WiFi.pak"
			return 1
			;;
	esac
}

main "$@"
